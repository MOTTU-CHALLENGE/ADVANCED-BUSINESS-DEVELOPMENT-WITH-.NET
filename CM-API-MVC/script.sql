-- Banco de dados gerado por EF Core para MySQL
-- Versão do EF Core: 9.0.0

CREATE TABLE IF NOT EXISTS `__EFMigrationsHistory` (
    `MigrationId` varchar(150) CHARACTER SET utf8mb4 NOT NULL,
    `ProductVersion` varchar(32) CHARACTER SET utf8mb4 NOT NULL,
    CONSTRAINT `PK___EFMigrationsHistory` PRIMARY KEY (`MigrationId`)
) CHARACTER SET=utf8mb4;

START TRANSACTION;
ALTER DATABASE CHARACTER SET utf8mb4;

-- Tabela de Filial
CREATE TABLE `T_CM_FILIAL` (
    `ID_FILIAL` int NOT NULL AUTO_INCREMENT,
    `NM_FILIAL` varchar(100) CHARACTER SET utf8mb4 NOT NULL,
    `DS_ENDERECO` varchar(255) CHARACTER SET utf8mb4 NOT NULL,
    `DS_CIDADE` varchar(100) CHARACTER SET utf8mb4 NOT NULL,
    `DS_ESTADO` varchar(50) CHARACTER SET utf8mb4 NOT NULL,
    `DS_PAIS` varchar(50) CHARACTER SET utf8mb4 NOT NULL,
    `CD_CEP` varchar(20) CHARACTER SET utf8mb4 NULL,
    `DS_TELEFONE` varchar(20) CHARACTER SET utf8mb4 NULL,
    `DT_INAUGURACAO` datetime(6) NULL,
    CONSTRAINT `PK_T_CM_FILIAL` PRIMARY KEY (`ID_FILIAL`)
) CHARACTER SET=utf8mb4;

-- Tabela de Pátio
-- tem relação N:1 com Filial
-- tem relação 1:N com Receptor WiFi
CREATE TABLE `T_CM_PATIO` (
    `ID_PATIO` int NOT NULL AUTO_INCREMENT,
    `ID_FILIAL` int NOT NULL,
    `NM_PATIO` varchar(100) CHARACTER SET utf8mb4 NOT NULL,
    `NR_CAP_MAX` int NULL,
    `VL_AREA_PATIO` decimal(6,2) NULL,
    `DS_OBS` longtext CHARACTER SET utf8mb4 NULL,
    CONSTRAINT `PK_T_CM_PATIO` PRIMARY KEY (`ID_PATIO`),
    CONSTRAINT `FK_T_CM_PATIO_T_CM_FILIAL_ID_FILIAL` FOREIGN KEY (`ID_FILIAL`) REFERENCES `T_CM_FILIAL` (`ID_FILIAL`) ON DELETE CASCADE
) CHARACTER SET=utf8mb4;

-- Tabela de Receptor WiFi
-- tem relação N:1 com Pátio
-- tem relação 1:N com Posição Moto
CREATE TABLE `T_CM_RECEPTOR_WIFI` (
    `ID_LEITOR` int NOT NULL AUTO_INCREMENT,
    `ID_PATIO` int NOT NULL,
    `DS_LOCAL_INSTALACAO` varchar(100) CHARACTER SET utf8mb4 NOT NULL,
    `DS_ENDERECO_MAC` varchar(17) CHARACTER SET utf8mb4 NOT NULL,
    `ST_STATUS` varchar(1) CHARACTER SET utf8mb4 NOT NULL,
    `DT_INSTALACAO` datetime(6) NOT NULL,
    `DS_OBS` longtext CHARACTER SET utf8mb4 NULL,
    CONSTRAINT `PK_T_CM_RECEPTOR_WIFI` PRIMARY KEY (`ID_LEITOR`),
    CONSTRAINT `FK_T_CM_RECEPTOR_WIFI_T_CM_PATIO_ID_PATIO` FOREIGN KEY (`ID_PATIO`) REFERENCES `T_CM_PATIO` (`ID_PATIO`) ON DELETE CASCADE
) CHARACTER SET=utf8mb4;

-- Tabela de Dispositivo IoT
-- tem relação N:1 com Moto
CREATE TABLE `T_CM_DISPOSITIVO_IOT` (
    `ID_DISPOSITIVO` int NOT NULL AUTO_INCREMENT,
    `NM_DISPOSITIVO` varchar(50) CHARACTER SET utf8mb4 NOT NULL,
    `DT_INSTALACAO` datetime(6) NOT NULL,
    `DS_OBS` longtext CHARACTER SET utf8mb4 NULL,
    `ID_MOTO` int NULL,
    CONSTRAINT `PK_T_CM_DISPOSITIVO_IOT` PRIMARY KEY (`ID_DISPOSITIVO`)
) CHARACTER SET=utf8mb4;

-- Tabela de Posição da Moto
-- tem relação N:1 com Dispositivo IoT
CREATE TABLE `T_CM_POSICAO_MOTO` (
    `ID_POSICAO` int NOT NULL AUTO_INCREMENT,
    `ID_DISPOSITIVO` int NOT NULL,
    `ID_PATIO` int NOT NULL,
    `COORD_X` double NOT NULL,
    `COORD_Y` double NOT NULL,
    `DT_REGISTRO` datetime(6) NOT NULL,
    `DS_SETOR` varchar(50) CHARACTER SET utf8mb4 NULL,
    CONSTRAINT `PK_T_CM_POSICAO_MOTO` PRIMARY KEY (`ID_POSICAO`),
    CONSTRAINT `FK_T_CM_POSICAO_MOTO_T_CM_DISPOSITIVO_IOT_ID_DISPOSITIVO` FOREIGN KEY (`ID_DISPOSITIVO`) REFERENCES `T_CM_DISPOSITIVO_IOT` (`ID_DISPOSITIVO`) ON DELETE CASCADE,
    CONSTRAINT `FK_T_CM_POSICAO_MOTO_T_CM_PATIO_ID_PATIO` FOREIGN KEY (`ID_PATIO`) REFERENCES `T_CM_PATIO` (`ID_PATIO`) ON DELETE CASCADE
) CHARACTER SET=utf8mb4;

-- Tabela de Moto
-- tem relação N:1 com RFID
CREATE TABLE `T_CM_MOTO` (
    `ID_MOTO` int NOT NULL AUTO_INCREMENT,
    `CD_TAG` varchar(50) CHARACTER SET utf8mb4 NULL,
    `TP_MOTO` varchar(20) CHARACTER SET utf8mb4 NOT NULL,
    `DS_PLACA` varchar(10) CHARACTER SET utf8mb4 NOT NULL,
    `ST_STATUS` varchar(1) CHARACTER SET utf8mb4 NOT NULL,
    `DT_CADASTRO` datetime(6) NOT NULL,
    `NR_ANO_FABRICACAO` int NULL,
    `DS_MODELO` varchar(50) CHARACTER SET utf8mb4 NULL,
    CONSTRAINT `PK_T_CM_MOTO` PRIMARY KEY (`ID_MOTO`)
) CHARACTER SET=utf8mb4;

-- Tabela de RFID
-- tem relação 1:1 com Moto
CREATE TABLE `T_CM_RFID` (
    `CD_TAG` varchar(50) CHARACTER SET utf8mb4 NOT NULL,
    `VL_FREQUENCIA` varchar(20) CHARACTER SET utf8mb4 NOT NULL,
    `ST_STATUS` varchar(1) CHARACTER SET utf8mb4 NOT NULL,
    `DT_ATIVACAO` datetime(6) NULL,
    `DS_OBS` longtext CHARACTER SET utf8mb4 NULL,
    `CodTag` int NULL,
    CONSTRAINT `PK_T_CM_RFID` PRIMARY KEY (`CD_TAG`),
    CONSTRAINT `FK_T_CM_RFID_T_CM_MOTO_CodTag` FOREIGN KEY (`CodTag`) REFERENCES `T_CM_MOTO` (`ID_MOTO`)
) CHARACTER SET=utf8mb4;

CREATE UNIQUE INDEX `IX_T_CM_DISPOSITIVO_IOT_ID_MOTO` ON `T_CM_DISPOSITIVO_IOT` (`ID_MOTO`);

CREATE UNIQUE INDEX `IX_T_CM_MOTO_CD_TAG` ON `T_CM_MOTO` (`CD_TAG`);

CREATE INDEX `IX_T_CM_PATIO_ID_FILIAL` ON `T_CM_PATIO` (`ID_FILIAL`);

CREATE INDEX `IX_T_CM_POSICAO_MOTO_ID_DISPOSITIVO` ON `T_CM_POSICAO_MOTO` (`ID_DISPOSITIVO`);

CREATE INDEX `IX_T_CM_POSICAO_MOTO_ID_PATIO` ON `T_CM_POSICAO_MOTO` (`ID_PATIO`);

CREATE INDEX `IX_T_CM_RECEPTOR_WIFI_ID_PATIO` ON `T_CM_RECEPTOR_WIFI` (`ID_PATIO`);

CREATE INDEX `IX_T_CM_RFID_CodTag` ON `T_CM_RFID` (`CodTag`);

ALTER TABLE `T_CM_DISPOSITIVO_IOT` ADD CONSTRAINT `FK_T_CM_DISPOSITIVO_IOT_T_CM_MOTO_ID_MOTO` FOREIGN KEY (`ID_MOTO`) REFERENCES `T_CM_MOTO` (`ID_MOTO`) ON DELETE SET NULL;

ALTER TABLE `T_CM_MOTO` ADD CONSTRAINT `FK_T_CM_MOTO_T_CM_RFID_CD_TAG` FOREIGN KEY (`CD_TAG`) REFERENCES `T_CM_RFID` (`CD_TAG`) ON DELETE SET NULL;

INSERT INTO `__EFMigrationsHistory` (`MigrationId`, `ProductVersion`)
VALUES ('20250914042203_CreateSchemaMottu', '9.0.0');

COMMIT;

